<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Dapur Kode - Model Context Protocol Dashboard</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <style>
            .sidebar {
                min-height: 100vh;
                background-color: #f8f9fa;
                padding: 20px;
                border-right: 1px solid #dee2e6;
            }
            .main-content {
                padding: 20px;
            }
            .model-card {
                cursor: pointer;
                transition: all 0.2s;
            }
            .model-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            }
            pre {
                background-color: #f8f9fa;
                padding: 10px;
                border-radius: 4px;
            }
            .table-list {
                max-height: 80vh;
                overflow-y: auto;
            }
        </style>
    </head>
    <body>
        <div class="container-fluid">
            <div class="row">
                <!-- Sidebar -->
                <div class="col-md-3 col-lg-2 sidebar">
                    <h4 class="mb-4">Dapur Kode</h4>
                    <div class="mb-4">
                        <h5>Models</h5>
                        <ul class="nav flex-column" id="models-list">
                            <!-- Models will be loaded here -->
                        </ul>
                    </div>
                    <div class="mb-4">
                        <h5>Database</h5>
                        <ul class="nav flex-column" id="tables-list">
                            <!-- Tables will be loaded here -->
                        </ul>
                    </div>
                </div>

                <!-- Main content area -->
                <div class="col-md-9 col-lg-10 main-content">
                    <div class="row mb-4">
                        <div class="col">
                            <h2 id="content-title">Project Overview</h2>
                        </div>
                    </div>

                    <!-- Overview tab (default) -->
                    <div id="overview-section">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mb-4">
                                    <div class="card-header">
                                        Project Structure
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-6">
                                                <h6>Models</h6>
                                                <ul id="overview-models">
                                                    <!-- Models will be loaded here -->
                                                </ul>
                                            </div>
                                            <div class="col-6">
                                                <h6>Controllers</h6>
                                                <ul id="overview-controllers">
                                                    <!-- Controllers will be loaded here -->
                                                </ul>
                                            </div>
                                        </div>
                                        <div class="row mt-3">
                                            <div class="col-6">
                                                <h6>Migrations</h6>
                                                <ul id="overview-migrations">
                                                    <!-- Migrations will be loaded here -->
                                                </ul>
                                            </div>
                                            <div class="col-6">
                                                <h6>Seeders</h6>
                                                <ul id="overview-seeders">
                                                    <!-- Seeders will be loaded here -->
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        Database Schema
                                    </div>
                                    <div class="card-body">
                                        <div id="schema-visualization">
                                            <p>
                                                Click on a table in the sidebar
                                                to view its schema.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Model detail section (hidden by default) -->
                    <div id="model-detail-section" style="display: none">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mb-4">
                                    <div class="card-header">
                                        Model Properties
                                    </div>
                                    <div class="card-body">
                                        <ul id="model-properties">
                                            <!-- Model properties will be loaded here -->
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card mb-4">
                                    <div class="card-header">Relations</div>
                                    <div class="card-body">
                                        <ul id="model-relations">
                                            <!-- Model relations will be loaded here -->
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Table detail section (hidden by default) -->
                    <div id="table-detail-section" style="display: none">
                        <div class="row">
                            <div class="col-md-5">
                                <div class="card mb-4">
                                    <div class="card-header">Table Schema</div>
                                    <div class="card-body">
                                        <pre id="table-schema">
                    <!-- Table schema will be loaded here -->
                  </pre>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-7">
                                <div class="card">
                                    <div class="card-header">Table Data</div>
                                    <div class="card-body">
                                        <div id="table-data">
                                            <!-- Table data will be loaded here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                // Fetch project structure
                fetch("/api/project-structure")
                    .then((response) => response.json())
                    .then((data) => {
                        // Populate models list
                        const modelsList =
                            document.getElementById("models-list");
                        const overviewModels =
                            document.getElementById("overview-models");
                        data.models.forEach((model) => {
                            // Sidebar list
                            const li = document.createElement("li");
                            li.className = "nav-item";
                            li.innerHTML = `<a class="nav-link model-link" href="#" data-model="${model}">${model}</a>`;
                            modelsList.appendChild(li);

                            // Overview list
                            const overviewLi = document.createElement("li");
                            overviewLi.textContent = model;
                            overviewModels.appendChild(overviewLi);
                        });

                        // Add event listeners to model links
                        document
                            .querySelectorAll(".model-link")
                            .forEach((link) => {
                                link.addEventListener("click", function (e) {
                                    e.preventDefault();
                                    const modelName =
                                        this.getAttribute("data-model");
                                    loadModelDetails(modelName);
                                });
                            });

                        // Populate controllers, migrations, seeders
                        document.getElementById(
                            "overview-controllers"
                        ).innerHTML = data.controllers
                            .map((item) => `<li>${item}</li>`)
                            .join("");
                        document.getElementById(
                            "overview-migrations"
                        ).innerHTML =
                            data.migrations
                                .slice(0, 10)
                                .map((item) => `<li>${item}</li>`)
                                .join("") +
                            (data.migrations.length > 10
                                ? `<li>...and ${
                                      data.migrations.length - 10
                                  } more</li>`
                                : "");
                        document.getElementById("overview-seeders").innerHTML =
                            data.seeders
                                .map((item) => `<li>${item}</li>`)
                                .join("");

                        // Populate tables list (assuming they are the same as models for simplicity)
                        const tablesList =
                            document.getElementById("tables-list");
                        data.models.forEach((model) => {
                            const tableName = model.toLowerCase() + "s"; // Simple pluralization
                            const li = document.createElement("li");
                            li.className = "nav-item";
                            li.innerHTML = `<a class="nav-link table-link" href="#" data-table="${tableName}">${tableName}</a>`;
                            tablesList.appendChild(li);
                        });

                        // Add event listeners to table links
                        document
                            .querySelectorAll(".table-link")
                            .forEach((link) => {
                                link.addEventListener("click", function (e) {
                                    e.preventDefault();
                                    const tableName =
                                        this.getAttribute("data-table");
                                    loadTableDetails(tableName);
                                });
                            });
                    })
                    .catch((error) =>
                        console.error(
                            "Error fetching project structure:",
                            error
                        )
                    );

                // Function to load model details
                function loadModelDetails(modelName) {
                    fetch(`/api/model/${modelName}`)
                        .then((response) => response.json())
                        .then((data) => {
                            // Update title
                            document.getElementById(
                                "content-title"
                            ).textContent = `Model: ${modelName}`;

                            // Show model section, hide others
                            document.getElementById(
                                "overview-section"
                            ).style.display = "none";
                            document.getElementById(
                                "model-detail-section"
                            ).style.display = "block";
                            document.getElementById(
                                "table-detail-section"
                            ).style.display = "none";

                            // Populate properties
                            const propertiesList =
                                document.getElementById("model-properties");
                            propertiesList.innerHTML = "";
                            data.properties.forEach((prop) => {
                                const li = document.createElement("li");
                                li.textContent = prop;
                                propertiesList.appendChild(li);
                            });

                            // Populate relations
                            const relationsList =
                                document.getElementById("model-relations");
                            relationsList.innerHTML = "";
                            data.relations.forEach((relation) => {
                                const li = document.createElement("li");
                                li.innerHTML = `<strong>${relation.name}</strong> (${relation.type}): ${relation.related_model}`;
                                relationsList.appendChild(li);
                            });
                        })
                        .catch((error) =>
                            console.error(
                                `Error loading model ${modelName}:`,
                                error
                            )
                        );
                }

                // Function to load table details
                function loadTableDetails(tableName) {
                    // Update title
                    document.getElementById(
                        "content-title"
                    ).textContent = `Table: ${tableName}`;

                    // Show table section, hide others
                    document.getElementById("overview-section").style.display =
                        "none";
                    document.getElementById(
                        "model-detail-section"
                    ).style.display = "none";
                    document.getElementById(
                        "table-detail-section"
                    ).style.display = "block";

                    // Fetch table schema
                    fetch(`/api/db/schema/${tableName}`)
                        .then((response) => response.json())
                        .then((data) => {
                            document.getElementById(
                                "table-schema"
                            ).textContent = data.schema;
                        })
                        .catch((error) => {
                            console.error(
                                `Error loading schema for ${tableName}:`,
                                error
                            );
                            document.getElementById(
                                "table-schema"
                            ).textContent = "Error loading schema";
                        });

                    // Fetch table data
                    fetch(`/api/db/table/${tableName}?limit=10`)
                        .then((response) => response.json())
                        .then((data) => {
                            document.getElementById(
                                "table-data"
                            ).innerHTML = `<pre>${data.data}</pre>`;
                        })
                        .catch((error) => {
                            console.error(
                                `Error loading data for ${tableName}:`,
                                error
                            );
                            document.getElementById("table-data").textContent =
                                "Error loading data";
                        });
                }
            });
        </script>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    </body>
</html>
